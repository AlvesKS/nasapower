---
title: "nasapower"
author: "Adam H Sparks"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{nasapower}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(nasapower)
knitr::opts_chunk$set(eval = FALSE,
                      collapse = TRUE,
                      comment = "#>",
                      fig.width = 7,
                      fig.height = 7,
                      fig.align = "center")
```

## Introduction

_nasapower_ aims to make it quick, easy and efficient to automate downloading
NASA-POWER global meteorology and surface solar energy data data in your R
session as a tidy data frame.

_nasapower_ only provides one function, `get_power()`, which will download
specified variables and return a tidy data frame of the requested data. Weather
variables can be specified by using the `pars` argument. 

## Using get_power()

The `get_power()` function requires five arguments as seen in this example.

```{r example, eval=FALSE}
power <- get_power(community = "AG",
                   latlon = c(-89.5, 179.5),
                   pars = c("RH2M", "T2M"),
                   dates = c("1985-01-01", "1985-12-31"),
                   temporal_average = "daily")
```

- `community`, a text string with valid values of: "AG" (Agroclimatology), "SSE"
(Surface meteorology and Solar Energy) or "SB" (Sustainable Buildings). The
selected user community will affect the units of the parameter and the temporal
display of time series data (_e.g._ Agroclimatology will use MJ/m^2^/day for
radiation units, while SSE and SB use kW/m^2^/day as units).

- `latlon`
  - *For a single point* To get a specific cell, 1/2 x 1/2 degree, supply a
    length-2 numeric vector giving the decimal degree longitude and latitude in
    that order for data to download,  *e.g.*, `latlon = c(-179.5, -89.5)`.  
  
  - *For regional coverage* To get a region, supply a length-4 numeric
    vector as lower left (lat, lon) and upper right (lat, lon) coordinates,
    *e.g.*, `latlon = c(ymin, xmin, ymax, xmax)` in that order for a given
    region, *e.g.*, a bounding box for the southwestern corner of Australia:
    `latlon = c(-55.5, 112.5, -50.5, 115.5)`. *Max bounding box is 10 x 10
    degrees* of 1/2 x 1/2 degree data, *i.e.*, 100 points maximum in total.  
  
  - *For global coverage* To get global coverage for long term monthly
    averages for the entire globe use `Global` in place of `latlon` values.
    `temporal_average` will automatically be set to `climatology` if this option
    is set.
    
- `pars`, A character vector of solar, meteorological or climatology parameters
to download. For a complete listing of valid `pars`, please visit the NASA-POWER
website for the dictionary of parameters,
<https://power.larc.nasa.gov/#resources>.

- `dates`, a vector of start and end dates for which to query the NASA-POWER
API, *e.g.*, `dates = c("1983-01-01", "2017-12-31")`. 

- `temporal_average`, a character vector of the desired temporal average(s).
Valid values are "DAILY", "INTERANNUAL" and "CLIMATOLOGY".

## Creating Spatial Objects

If you require spatial objects to work with, it is rather simple to convert
the resulting tidy data frame from `get_power()` to a spatial object in R using `raster::rasterFromXYZ()`.

### Converting Regional Data to a _raster_ Object

Using `lapply` and `split` it is easy to create stacks of raster objects from
a regional query.

```{r raster_example, eval=FALSE}
library(nasapower)
library(raster)

power <- get_power(community = "AG",
                   latlon = c(-55.5, 112.5, -50.5, 115.5),
                   pars = c("RH2M", "T2M"),
                   dates = c("1985-01-01", "1985-01-02"),
                   temporal_average = "daily")


# Use split to create a list of data frames split by YYYYMMDD
power <- split(power, power$YYYYMMDD)

# Remove date information from data frame, list names will carry YYYYMMDD
power <-
  lapply(power, function(x)
  x[(!names(x) %in% c("YEAR", "MM", "DD", "DOY", "YYYYMMDD"))])

# Create a list of raster bricks from each YYYYMMDD data frame
raster_list <- lapply(power, rasterFromXYZ,
              crs = "+proj=eqc +lat_ts=0 +lat_0=0 +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs ")
```

Plot the first item in the list.

```{r plot_fig1}
plot(raster_list[[1]])
```

![Plot of RH2M and T2M for Jan 1](../man/figures/nasapower_Figure1.png)

### Converting Global Climatology to a _raster_ Object

Converting global climatology to a `raster::brick` is as simple as querying
and then converting the resulting `tibble` to a raster object.

```{r global_climatology, eval=FALSE}
power <- get_power(
  community = "AG",
  latlon = "global",
  pars = c("RH2M", "T2M"),
  temporal_average = "climatology"
)

# create RasterBricks for the individual parameters and drop the parameter field
RH2M <- rasterFromXYZ(subset(power, PARAMETER == "RH2M")[, -3])

T2M <- rasterFromXYZ(subset(power, PARAMETER == "T2M")[, -3])
```

Plot the annual RH2M from the `RasterBrick` object.

```{r plot_RH2M_ANN}
plot(RH2M$ANN)
```

![Plot of ANN (annual mean) RH2M](../man/figures/nasapower_Figure2.png)

## References

<https://power.larc.nasa.gov>

<https://power.larc.nasa.gov/documents/Agroclimatology_Methodology.pdf>
