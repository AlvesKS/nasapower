---
title: "nasapower"
author: "Adam H Sparks"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{nasapower}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(nasapower)
knitr::opts_chunk$set(eval = FALSE,
                      collapse = TRUE,
                      comment = "#>",
                      fig.width = 7,
                      fig.height = 7,
                      fig.align = "center")
```

## Introduction

_nasapower_ aims to make it quick, easy and efficient to automate downloading
NASA-POWER agroclimatology data in your R session as a tidy data frame.

_nasapower_ only provides one function, `get_power()`, which will download
specified variables and return a tidy data frame of the requested data. Weather
variables can be specified by using the `pars` argument. 

## Using get_power()

The `get_power()` function requires five arguments as seen in this example.

```{r example, eval=FALSE}
power <- get_power(community = "AG",
                   lonlat = c(-179.5, -89.5),
                   pars = c("RH2M", "T2M"),
                   dates = c("1985-01-01", "1985-12-31"),
                   temporal_average = "daily")
```

- `community`, a text string with valid values of: "AG" (Agroclimatology), "SSE"
(Surface meteorology and Solar Energy) or "SB" (Sustainable Buildings). The
selected user community will affect the units of the parameter and the temporal
display of time series data (_e.g._ Agroclimatology will use MJ/m^2^/day for
radiation units, while SSE and SB use kW/m^2^/day as units).

- `lonlat`, a length-2 numeric vector giving the decimal degree longitude and
and latitude coordinates in that order for cell data to download or a length-4
numeric vector giving the decimal degree longitude and and latitude coordinates
forming a bounding box as ymin, xmin, ymax, xmax in that order. When specifying
a region, the maximum amount of cells that can be downloaded are 100, i.e. a 10
x 10 0.5˚ bounding box or 5 x 5 1˚ bounding box. Leave blank for global
coverage.

- `pars`, A character vector of solar or meteorological variables to download.
See the `Value` field of [`parameters`](../help/parameters) for a full list of
valid values or visit the [POWER website](https://power.larc.nasa.gov/new/) for
the Parameter Dictionary. If downloading global coverage a maximum of 3 `pars`
can be specified at one time.

- `dates`, a vector of start and end dates for which to query the NASA-POWER
API, *e.g.*, `dates = c("1983-01-01", "2017-12-31")`.

- `temporal_average`, a character vector of the desired temporal average(s).
Valid values are "DAILY", "INTERANNUAL" and "CLIMATOLOGY".


```{r get_philippines_example}

# get a sp data frame for the Philippines from naturalearthdata
PHL_adm <- rnaturalearth::ne_countries(scale = 50,
                                       country = "Philippines",
                                       returnclass = "sp")

# get the bounding box from the sp object to instruct the `lonlat` values
PHL_lonlat <- sp::bbox(PHL_adm)

PHL <- get_power(lonlat = c(PHL_lonlat[2, 1],
                            PHL_lonlat[1, 1],
                            PHL_lonlat[2, 2],
                            PHL_lonlat[1, 2]), 
                 pars = c("T2M", "RH2M"),
                 dates = c("2017-1-1", "2017-1-2"),
                 community = "AG",
                 temporal_average = "DAILY"
                 )
```

Using _ggplot2_, plot the downloaded data with an outline from
_Naturalearthdata_ for reference.

```{r plot_phl}
library(ggplot2)
library(viridis)

# Plot temperature
ggplot(PHL) +
  geom_tile(aes(x = LON, y = LAT, fill = T2M)) +
  scale_fill_viridis() +
   geom_polygon(data = PHL_adm, aes(x = long, y = lat, group = group), 
               fill = NA, color = "white", size = 1) +
  theme_bw() +
  coord_map() +
  facet_grid(. ~ YYYYMMDD) +
  ggtitle("Average Temperature (˚C)",
          subtitle = "Data sources\nTemperature: NASA - POWER\nPHL boundary: Naturalearthdata")

# Plot RH
ggplot(PHL, aes(x = LON, y = LAT, fill = RH2M)) +
  geom_tile() +
  scale_fill_viridis(option = "C") +
   geom_polygon(data = PHL_adm, aes(x = long, y = lat, group = group), 
               fill = NA, color = "white", size = 1) +
  theme_bw() +
  coord_map() +
  facet_grid(. ~ YYYYMMDD) +
    ggtitle("Average Relative Humidity (%)",
          subtitle = "Data sources\nRelative Humidity: NASA - POWER\nPHL boundary: Naturalearthdata")
```

![Philippine Temperature](plot_phl-1.png)
!["Philippine Relative Humidity"](plot_phl-2.png)

## Creating Spatial Objects

If you require spatial objects to work with, it is rather simple to convert
the resulting tidy data frame from either `get_cell()` or `get_region()` to a
spatial object in R using `raster::rasterFromXYZ()`.

### Converting to a _raster_ Object

Using the `PHL` object from the previous example, convert the data frame to a
raster brick. The LON and LAT values are in columns 6 and 7 with the weather
vars in any following columns.

The first step is to `base::split()` the data frame into a list of data frames by day.

Then convert the `base::list()` into a `list` of `raster::brick()` objects.

```{r raster_example}
library(raster)

# Use split to create a list of data frames split by YYYYMMDD
PHL <- split(PHL, PHL$YYYYMMDD)

# Remove date information from data frame, list names will carry YYYYMMDD
PHL <-
  lapply(PHL, function(x)
  x[(!names(x) %in% c("YEAR", "MONTH", "DAY", "YYYYMMDD", "DOY"))])

# Create a list of raster bricks from each YYYYMMDD data frame
PHL <- lapply(PHL, rasterFromXYZ,
              crs = "+proj=eqc +lat_ts=0 +lat_0=0 +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs ")
```

## References

<https://power.larc.nasa.gov>

<https://power.larc.nasa.gov/documents/Agroclimatology_Methodology.pdf>
