---
title: "Using nasapower to Create a Global Surface"
author: "Adam H. Sparks"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using nasapower to Create a Global Surface}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r check_packages, echo=FALSE, messages=FALSE, warning=FALSE}
required <- c("dplyr", "ggplot2", "raster", "virdis")

if (!all(unlist(lapply(required, function(pkg)
requireNamespace(pkg, quietly = TRUE)))))

knitr::opts_chunk$set(
eval = FALSE,
collapse = TRUE,
comment = "#>",
fig.width = 7,
fig.height = 7,
fig.align = "center"
)
```

Creating a complete global surface of NASA - POWER data is easy using
_nasapower_. However, the process is time-intensive since it requires many
queries of the server.

## Required libraries

```{r libraries, eval=FALSE}
library(dplyr)
library(ggplot2)
library(nasapower)
library(raster)
library(viridis)
```

Using the `raster` package generate a raster object at 1˚ by 1˚ to represent one
date of the NASA - POWER data.

```{r raster, eval=FALSE}
x <- raster()
```

Get the lon/lat values from the `x` _raster_ object to query from the NASA -
POWER website.

```{r xy_df, eval=FALSE}
xy <- data.frame(raster::xyFromCell(x, 1:64800))
```

Create a list of numeric vectors of lon/lat values for `get_nasa()` to use.

```{r numeric_vec, eval=FALSE}
# Create a list of lonlat objects
xy_list <- split(xy, seq(nrow(xy)))

# Convert the list to numeric vectors for `get_nasa()`
xy_list <- lapply(xy_list, function(x) as.numeric(x))
```

With the lon/lat values to provide to the `get_nasa()` function, we can now set
up the data download.

```{r fetch_data, eval=FALSE}

surface <- purrr::map_df(
  .x = xy_list,
  .f = get_nasa,
  stdate = "2017-1-1",
  endate = "2017-1-1",
  vars = c("T2M", "RH2M")
  )

```

## Mapping the data

Using _ggplot2_ it is possible to make simple maps of the data.

```{r}
# Plot temperature
ggplot(surface, aes(x = LON, y = LAT, fill = T2M)) +
  geom_tile() +
  scale_fill_viridis() +
  theme_bw() +
  coord_cartesian() +
  ggtitle("Average Temperature (˚C)")

# Plot RH
ggplot(surface, aes(x = LON, y = LAT, fill = RH2M)) +
  geom_tile() +
  scale_fill_viridis(option = "C") +
  theme_bw() +
  coord_cartesian() +
  ggtitle("Relative Humidity (%)")
```
