---
title: "Use Case: Using nasapower and the APSIM R Package to Create APSIM .met Files"
author: "Adam H. Sparks"
output:
  rmarkdown::html_vignette:
        toc: true
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center",
  eval = FALSE
)
```

# Introduction

NASA - POWER data are often used with APSIM (White _et al._ 2012) or other
models where data may be missing or as a whole data set where data are not
readily available, _e.g._ modelling rice disease globally (Savary _et al._
2012).

In this use case we illustrate how use NASA-POWER radiation data with existing
station data that lacks radiation and format for use in the APSIM model (Keating
et al. 2003) by creating a .met file using the R package, _APSIM_
(Fainges 2017).

# Install and Load Packages

```{r install_apsim, eval=FALSE}
install.packages("APSIM")
```

Load the packages necessary.

```{r load_libraries, message=FALSE, eval=TRUE}
library(APSIM)
library(nasapower)
library(ggplot2)
```

# Download NASA-POWER Solar Radiation Data

Using the `APSIM::prepareMet()` example, where data for Kingsthorpe, Qld,
is provided by the package, we can create an equivalent data set from the
NASA-POWER data compare it with the supplied data for Kingsthorpe, Queensland
location 151.81 degrees longitude and -27.48 degrees latitude, for 2010. As a
proxy for potential incoming radiation, `SRAD`, we'll use `ALLSKY_TOA_SW_DWN`,
top-of-atmosphere insolation, from NASA - POWER.

```{r get_data_show, eval=TRUE}
sw_dwn <- get_power(
  lonlat = c(151.81, -27.48),
  dates = c("2010-01-01", "2010-12-31"),
  pars = "ALLSKY_TOA_SW_DWN",
  community = "AG",
  temporal_average = "DAILY"
  )
```

# Compare the Data

To compare the data more easily using a graph and correlation measures, join the
two data frames to create a data frame called, `compare`.

```{r compare, eval=TRUE}
compare <- data.frame(kingsData$rad, sw_dwn$ALLSKY_TOA_SW_DWN)
```

## Graph the Data

Graph radiation values from the weather station at Kingsthorpe in
`APSIM::kingsData` along against the POWER data to illustrate why POWER data are
often used as a substitute for on-the-ground measurements.

```{r graph_rad, eval=TRUE}
ggplot(compare, aes(x = kingsData.rad, y = sw_dwn.ALLSKY_TOA_SW_DWN)) +
  geom_point(colour = "orange") +
  geom_abline(colour = "black", slope = 1) +
  theme_minimal()

cor(compare$kingsData.rad, compare$sw_dwn.ALLSKY_TOA_SW_DWN)
```

# Create a .met File

Now that we have the data from NASA-POWER, it's possible to create a .met file
for use in APSIM using the _APSIM_ package if the data are missing the solar
radiation. A duplicate data set of the `kingsData` from _APSIM_ has been
created, which has `rad` missing, `kings_nasa`. Using that data set, merge
with the `swv_dwn` from the POWER data and create an APSIM .met file.

```{r remove_rad, eval=FALSE, include=FALSE}
kings_nasa <- kingsData[, -6]
```

```{r create_met, eval=FALSE}

# inspect the kings_nasa data
str(kings_nasa)

# join the kings_data with swv_dwn from POWER
kings_met <- data.frame(kings_nasa, swv_dwn$swv_dwn)

# rearrange the columns to match expected order for .met file
kings_met <- kings_met[c(1:5, 10, 6:9)]

# from the APSIM documentation example
new_names <-
  c("Date",
    "maxt",
    "mint",
    "rain",
    "evaporation",
    "radn",
    "vp",
    "Wind",
    "RH",
    "SVP")

units <-
  c("()",
    "(oC)",
    "(oC)",
    "(mm)",
    "(mm)",
    "(MJ/m^2/day)",
    "()",
    "()",
    "()",
    "()")
```

Using the `kings_met` data frame created previously, along with the `new_names`
and `units` data frames, use `APSIM::prepareMet()` to create a .met file.

```{r prepare_met, eval=FALSE}
nasa_met <- prepareMet(kings_met,
           lat = -27.48,
           lon = 151.81,
           newNames = new_names,
           units = units)

str(nasa_met)
```

You now have a complete .met file for use in APSIM that supplies solar radiation
from the NASA-POWER data. It can be saved to local disk if desired using
`APSIM::writeMetFile()` from _APSIM_.

```{r write-met, eval=FALSE}
writeMetFile("NASA_rad.met", nasa_met)
```

# References

Justin Fainges (2017) "APSIM: General Utility Functions for the 'Agricultural
Production Systems Simulator'". R package version 0.9.2.
<https://CRAN.R-project.org/package=APSIM>

Keating, Brian A., Peter S. Carberry, Graeme L. Hammer, Mervyn E. Probert,
Michael J. Robertson, D. Holzworth, Neil I. Huth et al. "An overview of APSIM,
a model designed for farming systems simulation." European Journal of Agronomy
18, no. 3 (2003): 267-288.

Serge Savary, Andrew Nelson, Laetitia Willocquet, Ireneo Pangga and Jorrel
Aunario (2012) "Modeling and Mapping potential epidemics of rice diseases
globally" Crop Protection, Volume 34, Pages 6-17, ISSN 0261-2194 DOI:
10.1016/j.cropro.2011.11.009

Jeffrey W. White, Gerrit Hoogenboom, Paul W. Stackhouse, James M. Hoell (2009)
"Evaluation of NASA satellite- and assimilation model-derived long-term daily
temperature data over the continental US" Agricultural and Forest
Meteorology, Volume 148, Issue 10, 2008, Pages 1574-1584, ISSN 0168-1923, DOI:
10.1016/j.agrformet.2008.05.017.
